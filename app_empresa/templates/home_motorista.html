{% extends 'base_page.html' %}

{% block content %}
<div class="texto-card" id="textBemVindo" style="text-align: center; margin-bottom: 30px;"> 
    <h1>Bem-vindo, @motorista!</h1>
</div>
<h3>Você está operando na linha:</h3>
<h4 style="font-size: 30px;">13</h4>

<div class="texto-card-middle" id="textoMeio" style="text-align: center; margin-bottom: 30px;"> 
    <h1>Escaneie o QRCode</h1>
</div>

<button class="action-button" id="cameraButton">ABRIR CÂMERA</button>

<div id="reader" style="display: none; margin: 20px auto; max-width: 500px;"></div>
<div id="scan-result" style="text-align: center; margin-top: 15px; font-weight: bold; font-size: 1.2em;"></div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 2. Selecionando os elementos do DOM
    const cameraButton = document.getElementById('cameraButton');
    const readerDiv = document.getElementById('reader');
    const scanResultDiv = document.getElementById('scan-result');
    const textBemVindo = document.getElementById('textBemVindo');
    const textoMeio = document.getElementById('textoMeio');

    // 3. Instanciando o leitor de QRCode
    const html5QrCode = new Html5Qrcode("reader");
    let isScanning = false;

    // 4. Função de callback para SUCESSO na leitura
    const onScanSuccess = (decodedText, decodedResult) => {
        if (isScanning) {
            isScanning = false; // Impede múltiplas execuções
            
            // Pausa o scanner e para a câmera para economizar recursos
            html5QrCode.stop().then(() => {
                console.log("QR Code scanning is stopped.");
                
                // Exibe o resultado e a mensagem de validação
                scanResultDiv.style.color = 'blue';
                scanResultDiv.innerText = `Código "${decodedText}" lido. Validando...`;
                
                // Envia o código para o backend Django para validação
                fetch('/api/validar-bilhete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}' // Token de segurança do Django
                    },
                    body: JSON.stringify({ ticket_id: decodedText })
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Resposta do servidor:', data);
                    if (data.redirect_url) {
                        // Redireciona para a página de confirmação (sucesso ou erro)
                        window.location.href = data.redirect_url;
                    } else {
                        // Se não houver URL de redirecionamento, exibe o erro
                        scanResultDiv.style.color = 'red';
                        scanResultDiv.innerText = data.message || 'Erro desconhecido.';
                    }
                })
                .catch(error => {
                    console.error('Erro ao validar:', error);
                    scanResultDiv.style.color = 'red';
                    scanResultDiv.innerText = 'Ocorreu um erro na comunicação com o servidor.';
                });

            }).catch(err => {
                console.error("Falha ao parar o scanner.", err);
            });
        }
    };

    // 5. Lógica do botão "ABRIR CÂMERA"
    cameraButton.addEventListener('click', () => {
        // Esconde/mostra os elementos da UI
        readerDiv.style.display = 'block';
        cameraButton.style.display = 'none';
        textBemVindo.style.display = 'none';
        textoMeio.style.display = 'none';
        scanResultDiv.innerText = 'Aponte a câmera para o QR Code';

        // Inicia o scanner
        html5QrCode.start(
            { facingMode: "environment" }, // Usa a câmera traseira
            {
                fps: 10, // Quadros por segundo para escanear
                qrbox: { width: 250, height: 250 } // Tamanho da caixa de scan
            },
            onScanSuccess // Função de callback em caso de sucesso
        ).then(() => {
            isScanning = true; // Marca que o scan está ativo
        }).catch(err => {
            console.log(`Não foi possível iniciar o scanner. Erro: ${err}`);
            scanResultDiv.style.color = 'red';
            scanResultDiv.innerText = 'Erro ao abrir a câmera. Verifique as permissões.';
        });
    });
});
</script>
{% endblock %}

{% block middle-btn %} {% endblock %}

<style>
/* Seus estilos podem permanecer os mesmos */
.texto-card h1 {
    font-size: 50px;
    color: #0e0e0e;
    margin-top: -30%;
    font-weight: 600;
}
.texto-card-middle h1 {
    position: relative;
    margin-top: 80px;
    font-size: 30px;
    color: #0e0e0e;
    font-weight: 600;
}
.action-button {
    display: block;
    width: 280px;
    max-width: 90%;
    margin: 20px auto;
    padding: 12px;
    border: none;
    border-radius: 25px;
    background-color: #4FBFA5;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
}
</style>