{% extends 'base_page.html' %}

{% block content %}
<div class="texto-card" id="textBemVindo" style="text-align: center; margin-bottom: 30px;"> 
    <h1>Bem-vindo, @motorista!</h1>
</div>
<h3>Você está operando na linha:</h3>
<h4 style="font-size: 30px;">13</h4>

<div class="texto-card-middle" id="textoMeio" style="text-align: center; margin-bottom: 30px;"> 
    <h1>Escaneie o QRCode</h1>
</div>

<button class="action-button" id="cameraButton">ABRIR CÂMERA</button>

<div id="reader" style="display: none; margin: 20px auto; max-width: 500px;"></div>
<div id="scan-result" style="text-align: center; margin-top: 15px; font-weight: bold; font-size: 1.2em;"></div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM carregado. Script de scan inicializado.");

    // Elementos do DOM
    const cameraButton = document.getElementById('cameraButton');
    const readerDiv = document.getElementById('reader');
    const scanResultDiv = document.getElementById('scan-result');
    const textBemVindo = document.getElementById('textBemVindo');
    const textoMeio = document.getElementById('textoMeio');

    // Instância da biblioteca
    const html5QrCode = new Html5Qrcode("reader");
    let isScanning = false;

    // --- FUNÇÕES DE CALLBACK ---
    const onScanSuccess = (decodedText, decodedResult) => {
        if (isScanning) {
            isScanning = false;
            html5QrCode.stop().then(() => {
                console.log(`Código lido: ${decodedText}. Parando o scanner.`);
                scanResultDiv.style.color = 'blue';
                scanResultDiv.innerText = `Código "${decodedText}" lido. Validando...`;
                
                // A lógica de fetch para o backend permanece a mesma
                fetch('/api/validar-bilhete/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ ticket_id: decodedText })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    } else {
                        scanResultDiv.style.color = 'red';
                        scanResultDiv.innerText = data.message || 'Erro desconhecido.';
                    }
                })
                .catch(error => console.error('Erro no fetch:', error));

            }).catch(err => console.error("Falha ao parar o scanner.", err));
        }
    };
    
    const onScanFailure = (error) => { /* Silencioso */ };

    // --- LÓGICA DO BOTÃO ---
    cameraButton.addEventListener('click', () => {
        console.log("Botão 'ABRIR CÂMERA' clicado.");
        
        // Esconde e mostra os elementos da UI
        readerDiv.style.display = 'block';
        cameraButton.style.display = 'none';
        textBemVindo.style.display = 'none';
        textoMeio.style.display = 'none';
        scanResultDiv.innerText = 'Iniciando câmera...';

        // Configuração do scanner
        const config = { 
            fps: 10, 
            qrbox: { width: 250, height: 250 } 
        };

        // LÓGICA INTELIGENTE PARA SELECIONAR A CÂMERA
        Html5Qrcode.getCameras().then(cameras => {
            if (cameras && cameras.length) {
                let cameraId;
                // Procura por uma câmera traseira (ideal para celular)
                const rearCamera = cameras.find(camera => camera.label.toLowerCase().includes('back') || camera.label.toLowerCase().includes('traseira'));
                
                if (rearCamera) {
                    cameraId = rearCamera.id;
                    console.log(`Câmera traseira encontrada: ${rearCamera.label}`);
                } else {
                    // Se não encontrar, usa a primeira câmera da lista (ideal para desktop)
                    cameraId = cameras[0].id;
                    console.log(`Usando câmera padrão: ${cameras[0].label}`);
                }

                // Inicia o scanner com o ID da câmera selecionada
                html5QrCode.start(
                    cameraId, 
                    config, 
                    onScanSuccess, 
                    onScanFailure
                ).then(() => {
                    isScanning = true;
                    scanResultDiv.innerText = 'Aponte a câmera para o QR Code';
                    console.log("Scanner iniciado com sucesso.");
                }).catch(err => {
                    console.error(`Erro ao iniciar o scanner:`, err);
                    scanResultDiv.style.color = 'red';
                    scanResultDiv.innerText = 'Não foi possível iniciar o scanner.';
                });

            } else {
                console.error("Nenhuma câmera encontrada.");
                scanResultDiv.style.color = 'red';
                scanResultDiv.innerText = 'Nenhuma câmera foi encontrada no dispositivo.';
            }
        }).catch(err => {
            console.error("Erro ao obter lista de câmeras:", err);
            scanResultDiv.style.color = 'red';
            scanResultDiv.innerText = 'Erro ao acessar as câmeras. Verifique as permissões.';
        });
    });
});
</script>
{% endblock %}

{% block middle-btn %} {% endblock %}

<style>
/* Seus estilos podem permanecer os mesmos */
.texto-card h1 {
    font-size: 50px;
    color: #0e0e0e;
    margin-top: -30%;
    font-weight: 600;
}
.texto-card-middle h1 {
    position: relative;
    margin-top: 80px;
    font-size: 30px;
    color: #0e0e0e;
    font-weight: 600;
}
.action-button {
    display: block;
    width: 280px;
    max-width: 90%;
    margin: 20px auto;
    padding: 12px;
    border: none;
    border-radius: 25px;
    background-color: #4FBFA5;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 1px;
}
</style>